"use strict";
var _a = require('http'), createServer = _a.createServer, IncomingMessage = _a.IncomingMessage, ServerResponse = _a.ServerResponse, parse = require('url').parse, _b = require('path'), extname = _b.extname, join = _b.join, resolve = _b.resolve, _c = require('fs'), lstatSync = _c.lstatSync, readFileSync = _c.readFileSync, view = require('./view'), qs = require('querystring');
var settings = {} || Object.create(null);
module.exports = {
    bodyParser: function (req, callback) {
        var body = '';
        req.setEncoding('utf-8');
        req.on('data', function (chunk) { return (body += chunk); });
        req.on('data', function () { return callback(qs.parse(body)); });
    },
    dirname: function (directory) {
        return resolve(directory);
    },
    get: function (path, method) {
        this.register[path] = this.getRouter(method);
    },
    listen: function () {
        var server = createServer(this.handle);
        return server.listen.apply(server, arguments);
    },
    route: function (req) {
        var url = parse(req.url, true), handler;
        var path = Object.keys(this.register).map(function (item) { return item; });
        path.forEach(function (item) {
            var explodeX = item.split('/');
            var explodeY = req.url.split('/');
            if (item.search(':') > 1 && explodeX.length == explodeY.length) {
                var lastIndex = explodeX.slice(-1)[0];
                req.body = {};
                req.body[lastIndex.replace(':', '')] = explodeY.slice(-1).pop();
                req.body[explodeY.slice(-2)[0]] = item;
                if (item.search(explodeY.slice(-2)[0]) > 1) {
                    url.pathname = item;
                }
            }
        });
        handler = this.register[url.pathname];
        return !handler ? this.missing(req) : handler;
    },
    getRouter: function (method) {
        var app = this;
        return {
            get: function (req, res) {
                res.redirect = function (url) {
                    res.writeHead(301, {
                        'Cache-Control': 'no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0',
                        Location: url,
                    });
                    res.end();
                };
                res.render = function (filename, data, options) {
                    var viewpath = settings.hasOwnProperty('views')
                        ? settings.views
                        : resolve('views'), engine = settings.hasOwnProperty('engine')
                        ? settings.engine
                        : 'ejs', stats = lstatSync(join(resolve('node_modules'), engine));
                    filename = join(viewpath, filename + (settings['view extension'] || '.ejs'));
                    var View = new view({
                        filename: filename,
                        engine: stats.isDirectory() ? require(engine) : false,
                        path: viewpath,
                        data: typeof data == undefined ? {} : data,
                        options: typeof options == undefined
                            ? {
                                client: false,
                                strict: true,
                            }
                            : options,
                    });
                    return View.render(function (err, str) {
                        if (!err) {
                            res.write(str);
                            res.end();
                        }
                        else {
                            if (err.code == 'ENOENT') {
                                res.write(filename + ' tidak dapat ditemukan!');
                                res.end();
                            }
                            else {
                                res.write(err.toString());
                                res.end();
                            }
                        }
                    });
                };
                var body = '';
                req.setEncoding('utf-8');
                req.on('data', function (chunk) { return (body += chunk); });
                req.on('data', function () {
                    req.body = qs.parse(body);
                });
                return method.apply(this, [req, res]);
            },
            post: function (req, res) {
                var _this = this;
                res.redirect = function (url) {
                    res.writeHead(301, {
                        'Cache-Control': 'no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0',
                        Location: url,
                    });
                    res.end();
                };
                res.render = function (filename, data, options) {
                    var viewpath = settings.hasOwnProperty('views')
                        ? settings.views
                        : resolve('views'), engine = settings.hasOwnProperty('engine')
                        ? settings.engine
                        : 'ejs', stats = lstatSync(join(resolve('node_modules'), engine));
                    filename = join(viewpath, filename + (settings['view extension'] || '.ejs'));
                    var View = new view({
                        filename: filename,
                        engine: stats.isDirectory() ? require(engine) : false,
                        path: viewpath,
                        data: typeof data == undefined ? {} : data,
                        options: typeof options == undefined
                            ? {
                                client: false,
                                strict: true,
                            }
                            : options,
                    });
                    return View.render(function (err, str) {
                        if (!err) {
                            res.write(str);
                            res.end();
                        }
                        else {
                            if (err.code == 'ENOENT') {
                                res.write(filename + ' tidak dapat ditemukan!');
                                res.end();
                            }
                            else {
                                res.write(err.toString());
                                res.end();
                            }
                        }
                    });
                };
                if (app.requestMethod != req.method)
                    return app.missingRequestMethod.apply(this, [req, res]);
                app.bodyParser(req, function (result) {
                    req.body = result;
                    return method.apply(_this, [req, res]);
                });
            },
        };
    },
    missing: function (req) {
        var url = parse(req.url, true), filepath = settings.hasOwnProperty('public')
            ? join(settings.public, url.pathname)
            : join(resolve('public'), url.pathname), extension = String(extname(filepath)).toLowerCase(), mimeTypes = {
            '.html': 'text/html',
            '.js': 'text/javascript',
            '.min.js': 'text/javascript',
            '.css': 'text/css',
            '.min.css': 'text/css',
            '.ico': 'image/x-icon',
            '.json': 'application/json',
            '.png': 'image/png',
            '.jpg': 'image/jpg',
            '.gif': 'image/gif',
            '.svg': 'image/svg+xml',
            '.wav': 'audio/wav',
            '.mp4': 'video/mp4',
            '.woff': 'application/font-woff',
            '.ttf': 'application/font-ttf',
            '.eot': 'application/vnd.ms-fontobject',
            '.otf': 'application/font-otf',
            '.wasm': 'application/wasm',
        }, contentType = mimeTypes[extension];
        try {
            var data_1 = readFileSync(filepath);
            return this.getRouter(function (req, res) {
                res.writeHead(200, {
                    'Content-Type': contentType,
                });
                res.write(data_1);
                res.end();
            });
        }
        catch (e) {
            return this.getRouter(function (req, res) {
                res.writeHead(400, {
                    'Content-Type': 'text/plain',
                });
                res.write('[' + req.method + '] No route registered for ' + url.pathname);
                res.end();
            });
        }
    },
    missingRequestMethod: function (req, res) {
        res.writeHead(400, {
            'Content-Type': 'text/plain',
        });
        res.write('Router [' +
            req.method +
            '] diperlukan untuk menangani permintaan url: ' +
            req.url);
        res.end();
    },
    post: function (path, method) {
        this.requestMethod = String(this.post.name).toUpperCase();
        this.register[path] = this.getRouter(method);
    },
    use: function () {
        var params = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            params[_i] = arguments[_i];
        }
        params.reduce(function (key, value) { return (settings[key] = value); });
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQU0sSUFBQSxLQUFvRCxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQWpFLFlBQVksa0JBQUEsRUFBRSxlQUFlLHFCQUFBLEVBQUUsY0FBYyxvQkFBQSxFQUNqRCxLQUFLLEdBQUssT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFuQixFQUNQLEtBQTZCLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBMUMsT0FBTyxhQUFBLEVBQUUsSUFBSSxVQUFBLEVBQUUsT0FBTyxhQUFBLEVBQ3hCLEtBQThCLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBekMsU0FBUyxlQUFBLEVBQUUsWUFBWSxrQkFBQSxFQUN6QixJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUN4QixFQUFFLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBZTlCLElBQUksUUFBUSxHQUFhLEVBQUUsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRW5ELE1BQU0sQ0FBQyxPQUFPLEdBQUc7SUFDZixVQUFVLEVBQUUsVUFDVixHQUEyQixFQUMzQixRQUE0QjtRQUU1QixJQUFJLElBQUksR0FBVyxFQUFFLENBQUM7UUFFdEIsR0FBRyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN6QixHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxVQUFDLEtBQVksSUFBSyxPQUFBLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxFQUFmLENBQWUsQ0FBQyxDQUFDO1FBQ2xELEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLGNBQU0sT0FBQSxRQUFRLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUF4QixDQUF3QixDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELE9BQU8sRUFBRSxVQUFVLFNBQWlCO1FBQ2xD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QyxNQUFNLENBQUMsTUFBTSxDQUNYLFVBQUMsR0FBVyxFQUFFLEtBQXNCLElBQUssT0FBQSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsRUFBdkIsQ0FBdUIsQ0FDakUsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBjcmVhdGVTZXJ2ZXIsIEluY29taW5nTWVzc2FnZSwgU2VydmVyUmVzcG9uc2UgfSA9IHJlcXVpcmUoJ2h0dHAnKSxcclxuICB7IHBhcnNlIH0gPSByZXF1aXJlKCd1cmwnKSxcclxuICB7IGV4dG5hbWUsIGpvaW4sIHJlc29sdmUgfSA9IHJlcXVpcmUoJ3BhdGgnKSxcclxuICB7IGxzdGF0U3luYywgcmVhZEZpbGVTeW5jIH0gPSByZXF1aXJlKCdmcycpLFxyXG4gIHZpZXcgPSByZXF1aXJlKCcuL3ZpZXcnKSxcclxuICBxcyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7XHJcblxyXG4vKipcclxuICogVXNlIFR5cGVcclxuICpcclxuICogQHNpbmNlIHZlcnNpb24gMS4xLjhcclxuICovXHJcbnR5cGUgU2V0dGluZ3MgPSB7fTtcclxudHlwZSBtZXRob2QgPSAoXHJcbiAgcmVxdWVzdDogdHlwZW9mIEluY29taW5nTWVzc2FnZSxcclxuICByZXNwb25zZTogdHlwZW9mIFNlcnZlclJlc3BvbnNlXHJcbikgPT4gdm9pZDtcclxudHlwZSBib2R5UGFyc2VyQ2FsbGJhY2sgPSAocmVxdWVzdDogdHlwZW9mIHFzKSA9PiB2b2lkO1xyXG50eXBlIGNodW5rID0gdHlwZW9mIEJ1ZmZlcjtcclxuXHJcbmxldCBzZXR0aW5ncyA9IDxTZXR0aW5ncz57fSB8fCBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYm9keVBhcnNlcjogZnVuY3Rpb24gKFxyXG4gICAgcmVxOiB0eXBlb2YgSW5jb21pbmdNZXNzYWdlLFxyXG4gICAgY2FsbGJhY2s6IGJvZHlQYXJzZXJDYWxsYmFja1xyXG4gICkge1xyXG4gICAgbGV0IGJvZHk6IHN0cmluZyA9ICcnO1xyXG5cclxuICAgIHJlcS5zZXRFbmNvZGluZygndXRmLTgnKTtcclxuICAgIHJlcS5vbignZGF0YScsIChjaHVuazogY2h1bmspID0+IChib2R5ICs9IGNodW5rKSk7XHJcbiAgICByZXEub24oJ2RhdGEnLCAoKSA9PiBjYWxsYmFjayhxcy5wYXJzZShib2R5KSkpO1xyXG4gIH0sXHJcblxyXG4gIGRpcm5hbWU6IGZ1bmN0aW9uIChkaXJlY3Rvcnk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHJlc29sdmUoZGlyZWN0b3J5KTtcclxuICB9LFxyXG5cclxuICBnZXQ6IGZ1bmN0aW9uIChwYXRoOiBzdHJpbmcsIG1ldGhvZDogbWV0aG9kKSB7XHJcbiAgICB0aGlzLnJlZ2lzdGVyW3BhdGhdID0gdGhpcy5nZXRSb3V0ZXIobWV0aG9kKTtcclxuICB9LFxyXG5cclxuICBsaXN0ZW46IGZ1bmN0aW9uICgpIHtcclxuICAgIGxldCBzZXJ2ZXIgPSBjcmVhdGVTZXJ2ZXIodGhpcy5oYW5kbGUpO1xyXG4gICAgcmV0dXJuIHNlcnZlci5saXN0ZW4uYXBwbHkoc2VydmVyLCBhcmd1bWVudHMpO1xyXG4gIH0sXHJcblxyXG4gIHJvdXRlOiBmdW5jdGlvbiAocmVxOiB0eXBlb2YgSW5jb21pbmdNZXNzYWdlKSB7XHJcbiAgICBsZXQgdXJsOiB0eXBlb2YgcGFyc2UgPSBwYXJzZShyZXEudXJsLCB0cnVlKSxcclxuICAgICAgaGFuZGxlcjogb2JqZWN0IHwgdW5kZWZpbmVkO1xyXG5cclxuICAgIGxldCBwYXRoOiBzdHJpbmdbXSA9IE9iamVjdC5rZXlzKHRoaXMucmVnaXN0ZXIpLm1hcCgoaXRlbSkgPT4gaXRlbSk7XHJcbiAgICBwYXRoLmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgbGV0IGV4cGxvZGVYOiBzdHJpbmdbXSA9IGl0ZW0uc3BsaXQoJy8nKTtcclxuICAgICAgbGV0IGV4cGxvZGVZOiBzdHJpbmdbXSA9IHJlcS51cmwuc3BsaXQoJy8nKTtcclxuXHJcbiAgICAgIGlmIChpdGVtLnNlYXJjaCgnOicpID4gMSAmJiBleHBsb2RlWC5sZW5ndGggPT0gZXhwbG9kZVkubGVuZ3RoKSB7XHJcbiAgICAgICAgbGV0IFtsYXN0SW5kZXhdID0gZXhwbG9kZVguc2xpY2UoLTEpO1xyXG4gICAgICAgIHJlcS5ib2R5ID0ge307XHJcbiAgICAgICAgcmVxLmJvZHlbbGFzdEluZGV4LnJlcGxhY2UoJzonLCAnJyldID0gZXhwbG9kZVkuc2xpY2UoLTEpLnBvcCgpO1xyXG4gICAgICAgIHJlcS5ib2R5W2V4cGxvZGVZLnNsaWNlKC0yKVswXV0gPSBpdGVtO1xyXG5cclxuICAgICAgICBpZiAoaXRlbS5zZWFyY2goZXhwbG9kZVkuc2xpY2UoLTIpWzBdKSA+IDEpIHtcclxuICAgICAgICAgIHVybC5wYXRobmFtZSA9IGl0ZW07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBoYW5kbGVyID0gdGhpcy5yZWdpc3Rlclt1cmwucGF0aG5hbWVdO1xyXG4gICAgcmV0dXJuICFoYW5kbGVyID8gdGhpcy5taXNzaW5nKHJlcSkgOiBoYW5kbGVyO1xyXG4gIH0sXHJcblxyXG4gIGdldFJvdXRlcjogZnVuY3Rpb24gKG1ldGhvZDogbWV0aG9kKSB7XHJcbiAgICBjb25zdCBhcHAgPSB0aGlzO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIC8vIE1lbXByb3NlcyBtZXRvZGUgR0VUXHJcbiAgICAgIGdldDogZnVuY3Rpb24gKHJlcTogdHlwZW9mIEluY29taW5nTWVzc2FnZSwgcmVzOiB0eXBlb2YgU2VydmVyUmVzcG9uc2UpIHtcclxuICAgICAgICByZXMucmVkaXJlY3QgPSAodXJsOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIHJlcy53cml0ZUhlYWQoMzAxLCB7XHJcbiAgICAgICAgICAgICdDYWNoZS1Db250cm9sJzpcclxuICAgICAgICAgICAgICAnbm8tY2FjaGUsIHByaXZhdGUsIG5vLXN0b3JlLCBtdXN0LXJldmFsaWRhdGUsIG1heC1zdGFsZT0wLCBwb3N0LWNoZWNrPTAsIHByZS1jaGVjaz0wJyxcclxuICAgICAgICAgICAgTG9jYXRpb246IHVybCxcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgcmVzLmVuZCgpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmVzLnJlbmRlciA9IChmaWxlbmFtZTogc3RyaW5nLCBkYXRhOiBTZXR0aW5ncywgb3B0aW9uczogU2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgIGxldCB2aWV3cGF0aDogc3RyaW5nID0gc2V0dGluZ3MuaGFzT3duUHJvcGVydHkoJ3ZpZXdzJylcclxuICAgICAgICAgICAgICA/IHNldHRpbmdzLnZpZXdzXHJcbiAgICAgICAgICAgICAgOiByZXNvbHZlKCd2aWV3cycpLFxyXG4gICAgICAgICAgICBlbmdpbmU6IHN0cmluZyA9IHNldHRpbmdzLmhhc093blByb3BlcnR5KCdlbmdpbmUnKVxyXG4gICAgICAgICAgICAgID8gc2V0dGluZ3MuZW5naW5lXHJcbiAgICAgICAgICAgICAgOiAnZWpzJyxcclxuICAgICAgICAgICAgc3RhdHM6IHR5cGVvZiBsc3RhdFN5bmMgPSBsc3RhdFN5bmMoXHJcbiAgICAgICAgICAgICAgam9pbihyZXNvbHZlKCdub2RlX21vZHVsZXMnKSwgZW5naW5lKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgZmlsZW5hbWUgPSBqb2luKFxyXG4gICAgICAgICAgICB2aWV3cGF0aCxcclxuICAgICAgICAgICAgZmlsZW5hbWUgKyAoc2V0dGluZ3NbJ3ZpZXcgZXh0ZW5zaW9uJ10gfHwgJy5lanMnKVxyXG4gICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICBjb25zdCBWaWV3ID0gbmV3IHZpZXcoe1xyXG4gICAgICAgICAgICBmaWxlbmFtZSxcclxuICAgICAgICAgICAgZW5naW5lOiBzdGF0cy5pc0RpcmVjdG9yeSgpID8gcmVxdWlyZShlbmdpbmUpIDogZmFsc2UsXHJcbiAgICAgICAgICAgIHBhdGg6IHZpZXdwYXRoLFxyXG4gICAgICAgICAgICBkYXRhOiB0eXBlb2YgZGF0YSA9PSB1bmRlZmluZWQgPyB7fSA6IGRhdGEsXHJcbiAgICAgICAgICAgIG9wdGlvbnM6XHJcbiAgICAgICAgICAgICAgdHlwZW9mIG9wdGlvbnMgPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgICAgICAgICA/IHtcclxuICAgICAgICAgICAgICAgICAgICBjbGllbnQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0cmljdDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgOiBvcHRpb25zLFxyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIFZpZXcucmVuZGVyKFxyXG4gICAgICAgICAgICAoZXJyOiBvYmplY3QgfCBudWxsIHwgYW55LCBzdHI6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwpID0+IHtcclxuICAgICAgICAgICAgICBpZiAoIWVycikge1xyXG4gICAgICAgICAgICAgICAgcmVzLndyaXRlKHN0cik7XHJcbiAgICAgICAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PSAnRU5PRU5UJykge1xyXG4gICAgICAgICAgICAgICAgICByZXMud3JpdGUoZmlsZW5hbWUgKyAnIHRpZGFrIGRhcGF0IGRpdGVtdWthbiEnKTtcclxuICAgICAgICAgICAgICAgICAgcmVzLmVuZCgpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgcmVzLndyaXRlKGVyci50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgICAgcmVzLmVuZCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsZXQgYm9keSA9ICcnO1xyXG5cclxuICAgICAgICByZXEuc2V0RW5jb2RpbmcoJ3V0Zi04Jyk7XHJcbiAgICAgICAgcmVxLm9uKCdkYXRhJywgKGNodW5rOiBjaHVuaykgPT4gKGJvZHkgKz0gY2h1bmspKTtcclxuICAgICAgICByZXEub24oJ2RhdGEnLCAoKSA9PiB7XHJcbiAgICAgICAgICByZXEuYm9keSA9IHFzLnBhcnNlKGJvZHkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGhpcywgW3JlcSwgcmVzXSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIC8vIE1lbXByb3NlcyBtZXRvZGUgUE9TVFxyXG4gICAgICBwb3N0OiBmdW5jdGlvbiAocmVxOiB0eXBlb2YgSW5jb21pbmdNZXNzYWdlLCByZXM6IHR5cGVvZiBTZXJ2ZXJSZXNwb25zZSkge1xyXG4gICAgICAgIHJlcy5yZWRpcmVjdCA9ICh1cmw6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgcmVzLndyaXRlSGVhZCgzMDEsIHtcclxuICAgICAgICAgICAgJ0NhY2hlLUNvbnRyb2wnOlxyXG4gICAgICAgICAgICAgICduby1jYWNoZSwgcHJpdmF0ZSwgbm8tc3RvcmUsIG11c3QtcmV2YWxpZGF0ZSwgbWF4LXN0YWxlPTAsIHBvc3QtY2hlY2s9MCwgcHJlLWNoZWNrPTAnLFxyXG4gICAgICAgICAgICBMb2NhdGlvbjogdXJsLFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXMucmVuZGVyID0gKGZpbGVuYW1lOiBzdHJpbmcsIGRhdGE6IFNldHRpbmdzLCBvcHRpb25zOiBTZXR0aW5ncykgPT4ge1xyXG4gICAgICAgICAgbGV0IHZpZXdwYXRoOiBzdHJpbmcgPSBzZXR0aW5ncy5oYXNPd25Qcm9wZXJ0eSgndmlld3MnKVxyXG4gICAgICAgICAgICAgID8gc2V0dGluZ3Mudmlld3NcclxuICAgICAgICAgICAgICA6IHJlc29sdmUoJ3ZpZXdzJyksXHJcbiAgICAgICAgICAgIGVuZ2luZTogc3RyaW5nID0gc2V0dGluZ3MuaGFzT3duUHJvcGVydHkoJ2VuZ2luZScpXHJcbiAgICAgICAgICAgICAgPyBzZXR0aW5ncy5lbmdpbmVcclxuICAgICAgICAgICAgICA6ICdlanMnLFxyXG4gICAgICAgICAgICBzdGF0czogdHlwZW9mIGxzdGF0U3luYyA9IGxzdGF0U3luYyhcclxuICAgICAgICAgICAgICBqb2luKHJlc29sdmUoJ25vZGVfbW9kdWxlcycpLCBlbmdpbmUpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICBmaWxlbmFtZSA9IGpvaW4oXHJcbiAgICAgICAgICAgIHZpZXdwYXRoLFxyXG4gICAgICAgICAgICBmaWxlbmFtZSArIChzZXR0aW5nc1sndmlldyBleHRlbnNpb24nXSB8fCAnLmVqcycpXHJcbiAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgIGNvbnN0IFZpZXcgPSBuZXcgdmlldyh7XHJcbiAgICAgICAgICAgIGZpbGVuYW1lLFxyXG4gICAgICAgICAgICBlbmdpbmU6IHN0YXRzLmlzRGlyZWN0b3J5KCkgPyByZXF1aXJlKGVuZ2luZSkgOiBmYWxzZSxcclxuICAgICAgICAgICAgcGF0aDogdmlld3BhdGgsXHJcbiAgICAgICAgICAgIGRhdGE6IHR5cGVvZiBkYXRhID09IHVuZGVmaW5lZCA/IHt9IDogZGF0YSxcclxuICAgICAgICAgICAgb3B0aW9uczpcclxuICAgICAgICAgICAgICB0eXBlb2Ygb3B0aW9ucyA9PSB1bmRlZmluZWRcclxuICAgICAgICAgICAgICAgID8ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgc3RyaWN0OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICA6IG9wdGlvbnMsXHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICByZXR1cm4gVmlldy5yZW5kZXIoXHJcbiAgICAgICAgICAgIChlcnI6IG9iamVjdCB8IG51bGwgfCBhbnksIHN0cjogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICByZXMud3JpdGUoc3RyKTtcclxuICAgICAgICAgICAgICAgIHJlcy5lbmQoKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09ICdFTk9FTlQnKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJlcy53cml0ZShmaWxlbmFtZSArICcgdGlkYWsgZGFwYXQgZGl0ZW11a2FuIScpO1xyXG4gICAgICAgICAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICByZXMud3JpdGUoZXJyLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChhcHAucmVxdWVzdE1ldGhvZCAhPSByZXEubWV0aG9kKVxyXG4gICAgICAgICAgcmV0dXJuIGFwcC5taXNzaW5nUmVxdWVzdE1ldGhvZC5hcHBseSh0aGlzLCBbcmVxLCByZXNdKTtcclxuXHJcbiAgICAgICAgYXBwLmJvZHlQYXJzZXIocmVxLCAocmVzdWx0OiBib2R5UGFyc2VyQ2FsbGJhY2spID0+IHtcclxuICAgICAgICAgIHJlcS5ib2R5ID0gcmVzdWx0O1xyXG5cclxuICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGhpcywgW3JlcSwgcmVzXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG4gIH0sXHJcblxyXG4gIG1pc3Npbmc6IGZ1bmN0aW9uIChyZXE6IHR5cGVvZiBJbmNvbWluZ01lc3NhZ2UpIHtcclxuICAgIGNvbnN0IHVybDogdHlwZW9mIHBhcnNlID0gcGFyc2UocmVxLnVybCwgdHJ1ZSksXHJcbiAgICAgIGZpbGVwYXRoOiBzdHJpbmcgPSBzZXR0aW5ncy5oYXNPd25Qcm9wZXJ0eSgncHVibGljJylcclxuICAgICAgICA/IGpvaW4oc2V0dGluZ3MucHVibGljLCB1cmwucGF0aG5hbWUpXHJcbiAgICAgICAgOiBqb2luKHJlc29sdmUoJ3B1YmxpYycpLCB1cmwucGF0aG5hbWUpLFxyXG4gICAgICBleHRlbnNpb246IHN0cmluZyA9IFN0cmluZyhleHRuYW1lKGZpbGVwYXRoKSkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgbWltZVR5cGVzOiBvYmplY3QgfCBhbnkgPSB7XHJcbiAgICAgICAgJy5odG1sJzogJ3RleHQvaHRtbCcsXHJcbiAgICAgICAgJy5qcyc6ICd0ZXh0L2phdmFzY3JpcHQnLFxyXG4gICAgICAgICcubWluLmpzJzogJ3RleHQvamF2YXNjcmlwdCcsXHJcbiAgICAgICAgJy5jc3MnOiAndGV4dC9jc3MnLFxyXG4gICAgICAgICcubWluLmNzcyc6ICd0ZXh0L2NzcycsXHJcbiAgICAgICAgJy5pY28nOiAnaW1hZ2UveC1pY29uJyxcclxuICAgICAgICAnLmpzb24nOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJy5wbmcnOiAnaW1hZ2UvcG5nJyxcclxuICAgICAgICAnLmpwZyc6ICdpbWFnZS9qcGcnLFxyXG4gICAgICAgICcuZ2lmJzogJ2ltYWdlL2dpZicsXHJcbiAgICAgICAgJy5zdmcnOiAnaW1hZ2Uvc3ZnK3htbCcsXHJcbiAgICAgICAgJy53YXYnOiAnYXVkaW8vd2F2JyxcclxuICAgICAgICAnLm1wNCc6ICd2aWRlby9tcDQnLFxyXG4gICAgICAgICcud29mZic6ICdhcHBsaWNhdGlvbi9mb250LXdvZmYnLFxyXG4gICAgICAgICcudHRmJzogJ2FwcGxpY2F0aW9uL2ZvbnQtdHRmJyxcclxuICAgICAgICAnLmVvdCc6ICdhcHBsaWNhdGlvbi92bmQubXMtZm9udG9iamVjdCcsXHJcbiAgICAgICAgJy5vdGYnOiAnYXBwbGljYXRpb24vZm9udC1vdGYnLFxyXG4gICAgICAgICcud2FzbSc6ICdhcHBsaWNhdGlvbi93YXNtJyxcclxuICAgICAgfSxcclxuICAgICAgY29udGVudFR5cGU6IHN0cmluZyA9IG1pbWVUeXBlc1tleHRlbnNpb25dO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCBkYXRhOiB0eXBlb2YgcmVhZEZpbGVTeW5jID0gcmVhZEZpbGVTeW5jKGZpbGVwYXRoKTtcclxuXHJcbiAgICAgIHJldHVybiB0aGlzLmdldFJvdXRlcihcclxuICAgICAgICAocmVxOiB0eXBlb2YgSW5jb21pbmdNZXNzYWdlLCByZXM6IHR5cGVvZiBTZXJ2ZXJSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHtcclxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IGNvbnRlbnRUeXBlLFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICByZXMud3JpdGUoZGF0YSk7XHJcbiAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRSb3V0ZXIoXHJcbiAgICAgICAgKHJlcTogdHlwZW9mIEluY29taW5nTWVzc2FnZSwgcmVzOiB0eXBlb2YgU2VydmVyUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgIHJlcy53cml0ZUhlYWQoNDAwLCB7XHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAndGV4dC9wbGFpbicsXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIHJlcy53cml0ZShcclxuICAgICAgICAgICAgJ1snICsgcmVxLm1ldGhvZCArICddIE5vIHJvdXRlIHJlZ2lzdGVyZWQgZm9yICcgKyB1cmwucGF0aG5hbWVcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG1pc3NpbmdSZXF1ZXN0TWV0aG9kOiBmdW5jdGlvbiAoXHJcbiAgICByZXE6IHR5cGVvZiBJbmNvbWluZ01lc3NhZ2UsXHJcbiAgICByZXM6IHR5cGVvZiBTZXJ2ZXJSZXNwb25zZVxyXG4gICkge1xyXG4gICAgcmVzLndyaXRlSGVhZCg0MDAsIHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L3BsYWluJyxcclxuICAgIH0pO1xyXG4gICAgcmVzLndyaXRlKFxyXG4gICAgICAnUm91dGVyIFsnICtcclxuICAgICAgICByZXEubWV0aG9kICtcclxuICAgICAgICAnXSBkaXBlcmx1a2FuIHVudHVrIG1lbmFuZ2FuaSBwZXJtaW50YWFuIHVybDogJyArXHJcbiAgICAgICAgcmVxLnVybFxyXG4gICAgKTtcclxuICAgIHJlcy5lbmQoKTtcclxuICB9LFxyXG5cclxuICBwb3N0OiBmdW5jdGlvbiAocGF0aDogc3RyaW5nLCBtZXRob2Q6IG1ldGhvZCkge1xyXG4gICAgdGhpcy5yZXF1ZXN0TWV0aG9kID0gU3RyaW5nKHRoaXMucG9zdC5uYW1lKS50b1VwcGVyQ2FzZSgpO1xyXG4gICAgdGhpcy5yZWdpc3RlcltwYXRoXSA9IHRoaXMuZ2V0Um91dGVyKG1ldGhvZCk7XHJcbiAgfSxcclxuXHJcbiAgdXNlOiBmdW5jdGlvbiAoLi4ucGFyYW1zOiBvYmplY3QgfCBhbnkpIHtcclxuICAgIHBhcmFtcy5yZWR1Y2UoXHJcbiAgICAgIChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IG9iamVjdCkgPT4gKHNldHRpbmdzW2tleV0gPSB2YWx1ZSlcclxuICAgICk7XHJcbiAgfSxcclxufTtcclxuIl19